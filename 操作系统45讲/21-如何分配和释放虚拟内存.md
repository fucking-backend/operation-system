## 如何分配和释放虚拟内存？

### 虚拟地址空间的分配和释放

整个虚拟地址空间就是由一个个虚拟地址区间组成的。分配一个虚拟地址空间就是在整个虚拟地址空间分割出一个区域，而释放一块虚拟地址空间，就是把这个区域合并到整个虚拟地址空间中去。

### 虚拟地址空间分配接口

分配虚拟地址空间应该有大小、有类型、有相关标志，还有从哪里开始分配等信息。

### 分配时查找虚拟地址区间
### 虚拟地址空间释放接口

因为分配虚拟地址空间时，我们为了节约 kmvarsdsc_t 结构占用的内存空间，规定只要分配的虚拟地址空间上一个虚拟地址空间是连续且类型相同的，我们就借用上一个 kmvarsdsc_t 结构，而不是重新分配一个 kmvarsdsc_t 结构表示新分配的虚拟地址空间。

### 释放时查找虚拟地址区间

释放时，查找虚拟地址区间的函数非常简单，仅仅是检查释放的虚拟地址空间是否落在查找 kmvarsdsc_t 结构表示的虚拟地址区间中，而可能的四种变换形式，交给核心释放函数处理。

### 测试环节：虚拟空间能正常访问么？
### 准备工作
### 异常情况与原因分析

为什么会发生**缺页异常**呢？因为我们访问了一个虚拟地址，这个虚拟地址由 CPU 发送给 MMU，而 MMU 无法把它转换成对应的物理地址，CPU 的那条访存指令无法执行了，因此就产生一个缺页异常。于是，CPU 跳转到缺页异常处理的入口地址（kernel.asm 文件中的 exc_page_fault 标号处）开始执行代码，处理这个缺页异常。

### 处理缺页异常核心

1. 首先，查找缺页地址对应的 kmvarsdsc_t 结构，没找到说明没有分配该虚拟地址空间，那属于非法访问不予处理；
2. 然后，查找 kmvarsdsc_t 结构下面的对应 kvmemcbox_t 结构，它是用来挂载物理内存页面的；
3. 最后，分配物理内存页面并建立 MMU 页表映射关系。

### 缺页地址是否合法
### 建立 kvmemcbox_t 结构

kvmemcbox_t 结构可以用来挂载物理内存页面 msadsc_t 结构，而这个 msadsc_t 结构是由虚拟地址区间 kmvarsdsc_t 结构代表的虚拟空间所映射的物理内存页面。一个 kmvarsdsc_t 结构，必须要有一个 kvmemcbox_t 结构，才能分配物理内存。除了这个功能，kvmemcbox_t 结构还可以在内存共享的时候使用。

### 映射物理内存页



### 思考题

请问，x86 CPU 的缺页异常，是第几号异常？缺页的地址保存在哪个寄存器中？

### question

捋清数据结构之间的关系是重点： virmemadrs_t,kmvarsdsc_t,kvmemcbox_t

1. 虚拟地址空间分配/释放接口，分配/释放时查找虚拟地址空间（难懂!!!!!!）
2. 处理缺页异常
3. 映射物理内存页
