## 设置工作模式与环境（下）：探查和收集信息

在二级引导器中，我们要检查 CPU 是否支持 64 位的工作模式、收集内存布局信息，看看是不是合乎我们操作系统的最低运行要求，还要设置操作系统需要的 MMU 页表、设置显卡模式、释放中文字体文件。

### 检查与收集机器信息
### 检查CPU
### 获取内存布局
### 初始化内核栈
### 放置内核文件与字库文件

因为我们的内核已经编译成了一个独立的二进制程序，和其它文件一起被打包到映像文件中了。所以我们必须要从映像中把它解包出来，将其放在特定的物理内存空间中才可以

### 建立MMU页表数据
### 设置图形模式

在计算机加电启动时，计算机上显卡会自动进入文本模式，文本模式只能显示 ASCII 字符，不能显示汉字和图形，所以我们要让显卡切换到图形模式。**切换显卡模式依然要用 BIOS 中断**

### 串联

```c
void init_bstartparm()
{
    machbstart_t *mbsp = MBSPADR;
    machbstart_t_init(mbsp);
    //检查CPU
    init_chkcpu(mbsp);
    //获取内存布局
    init_mem(mbsp);
    //初始化内核栈
    init_krlinitstack(mbsp);
    //放置内核文件
    init_krlfile(mbsp);
    //放置字库文件
    init_defutfont(mbsp);
    init_meme820(mbsp);
    //建立MMU页表
    init_bstartpages(mbsp);
    //设置图形模式
    init_graph(mbsp);
    return;
}
```

### 显示LOGO
### 进入Cosmos

我们在调用 Cosmos 第一个 C 函数之前，我们依然要写一小段汇编代码，切换 CPU 到长模式，初始化 CPU 寄存器和 C 语言要用的栈。因为目前代码执行流在二级引导器中，进入到 Cosmos 中这样在二级引导器中初始过的东西都不能用了。

因为 CPU 进入了长模式，寄存器的位宽都变了，所以需要重新初始化。

### 总结

1. 二级引导器彻底摆脱了 GRUB 的控制之后，就开始检查 CPU，获取内存布局信息，确认是不是我们要求的 CPU 和内存大小，接着初始化内核栈、放置好内核文件和字库文件，建立 MMU 页表数据和设置好图形模式，为后面运行内核做好准备。
2. 当二级引导器完成了上述功能后，就会显示我们操作系统的 logo，这标志着二级引导器所有的工作一切正常。
3. 进入 Cosmos，我们的二级引导器通过跳转到 Cosmos 的入口，结束了自己光荣使命，Cosmos 的入口是一小段汇编代码，主要是开启 CPU 的长模式，最后调用了 Cosmos 的第一个 C 函数 hal_start。

### 思考题

请你想一下，init_bstartparm() 函数中的 init_mem820() 函数，这个函数到底干了什么？

### question

1. init_bstartparm
2. 获取内存布局和“获取内存视图” （难懂）。init_mem调用mmap，得到e820map结构数组。（没懂）
3. 初始化内核栈（做了个什么）
4. ”放置内核文件和字库文件“与inithead_entry实现的功能类似
5. 建立MMU页表数据 （难懂）
6. 设置图形模式 （很难懂，可以先跳过）
7. init_entry.asm重新初始化？ （没懂）
