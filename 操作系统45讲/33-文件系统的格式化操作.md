## 仓库划分：文件系统的格式化操作

我们已经设计好了文件系统数据结构，相当于建好了仓库的基本结构。

这一节一起探索仓库的划分，即什么地方存放仓库的管理信息，什么地方存放进程的“劳动成果”（也就是文件），对应于文件系统就是文件系统的格式化操作。

### 文件系统设备
### 文件系统格式化

我们经常听说格式化硬盘、格式化 U 盘，可以把设备上的数据全部清空，事实是格式化操作并不是把设备上所有的空间都清零，而是在这个设备上重建了文件系统用于管理文件的那一整套数据结构。这也解释了为什么格式化后的设备，还能通过一些反删除软件找回一些文件。

在储存设备上创建文件系统，其实就是执行这个格式化操作，即重建文件系统的数据结构。

### 建立超级块

建立超级块其实非常简单，就是初始化超级块的数据结构，然后把它写入到储存设备中的第一块逻辑储存块。

### 建立位图

储存设备被分成了许多同等大小的逻辑储存块，位图就是为了能准确地知道储存设备中，哪些逻辑储存块空闲、哪些是被占用的。

我们使用一个逻辑储存块空间中的所有字节，来管理逻辑储存块的状态。建立位图无非就是把储存设备中的位图块清零，因为开始文件系统刚创建时，所有的逻辑储存块都是空闲的。

### 建立根目录

一切目录和文件都是存放在根目录下的，查询目录和文件也是从这里开始的，所以文件系统创建的最后一步就是创建根目录。

### 串联
### 测试文件系统
### 测试文件系统超级块/位图/根目录

### 思考题

建立文件系统的超级块、位图、根目录的三大函数的调用顺序可以随意调换吗，原因是什么？

### question

```sh

二、文件系统初始化
1、文件系统本身是个驱动，同样需要把驱动放到全局驱动列表中
osdrvetytabl={systick_entry,rfs_entry,NULL}

2、从而，让系统启动时自动加载驱动
hal_start->init_krl->init_krldriver->rfs_entry
new_device_dsc，分配内存
new_rfsdevext_mmblk，分配设备内存
krldev_add_driver，处理驱动
krlnew_device，处理设备
init_rfs->rfs_fmat，初始化文件系统

3、其中，主要逻辑是在rfs_fmat中实现的：
A、create_superblk->rfssublk_t_init->rfsdir_t_init，创建超级块。其中初始化超级块时可以看到：
超级块在第0个逻辑块，位图在第1个逻辑块，根目录为空
B、create_bitmap
标记前3个逻辑块为已占用，后续逻辑块为可用
C、create_rootdir
一方面在超级块中标明，根目录在第2块
另一方面，对根目录进行初始化，写入 fimgrhd_t文件管理头，后续有文件就要在这个文件管理头后面依次增加rfsdir_t结构

三、逻辑块使用
1、申请逻辑块
A、读取超级块，从而定位到位图块
B、读取位图块
C、位图中找到第一个可用逻辑块，并设置为使用，并返回该字节对应的逻辑块号

2、归还逻辑块
A、读取超级块，从而定位到位图块
B、读取位图块
C、位图中找到对应的逻辑块，并设置为空闲

```